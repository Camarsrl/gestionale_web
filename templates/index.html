{% extends "layout.html" %}

{% block custom_css %}
<style>
    /* Imposta la pagina in modo che la tabella abbia scroll indipendente */
    .page-wrapper {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 120px);
        overflow: hidden;
    }

    .filters-card {
        flex-shrink: 0;
    }

    .table-wrapper {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: white;
        min-height: 0;
    }

    table.table-giacenze {
        table-layout: fixed;
        min-width: 2600px;
        font-size: 0.875rem;
        width: 100%;
        border-collapse: collapse;
    }

    table.table-giacenze th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #f8f9fa;
        text-align: center;
        border-bottom: 2px solid #ccc;
    }

    table.table-giacenze td, table.table-giacenze th {
        white-space: normal;
        word-wrap: break-word;
        vertical-align: middle;
        padding: 4px 6px;
    }

    .table-container {
        height: 100%;
    }

    .card-footer {
        flex-shrink: 0;
        background-color: #f8f9fa;
        border-top: 1px solid #ddd;
        padding: 8px 12px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">

    <!-- Filtri di ricerca -->
    <div class="card mb-3 filters-card">
        <div class="card-header" data-bs-toggle="collapse" href="#filtriCollapse" role="button" aria-expanded="true">
            <h5 class="mb-0">Filtri di Ricerca</h5>
        </div>
        <div class="collapse" id="filtriCollapse">
            <div class="card-body">
                <form method="GET" action="{{ url_for('visualizza_giacenze') }}">
                    <div class="row g-2">
                        <div class="col-md-2">
                            <label class="form-label form-label-sm">Codice Articolo</label>
                            <input type="text" name="codice_articolo" class="form-control form-control-sm" value="{{ filters.get('codice_articolo', '') }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label form-label-sm">Descrizione</label>
                            <input type="text" name="descrizione" class="form-control form-control-sm" value="{{ filters.get('descrizione', '') }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label form-label-sm">Cliente</label>
                            <input type="text" name="cliente" class="form-control form-control-sm" value="{{ filters.get('cliente', '') }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label form-label-sm">Fornitore</label>
                            <input type="text" name="fornitore" class="form-control form-control-sm" value="{{ filters.get('fornitore', '') }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label form-label-sm">N. DDT Uscita</label>
                            <input type="text" name="n_ddt_uscita" class="form-control form-control-sm" value="{{ filters.get('n_ddt_uscita', '') }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label form-label-sm">Data Uscita Da</label>
                            <input type="date" name="data_uscita_da" class="form-control form-control-sm" value="{{ filters.get('data_uscita_da', '') }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label form-label-sm">Data Uscita A</label>
                            <input type="date" name="data_uscita_a" class="form-control form-control-sm" value="{{ filters.get('data_uscita_a', '') }}">
                        </div>
                    </div>
                    <div class="mt-2 text-end">
                        <button type="submit" class="btn btn-sm btn-primary">Applica Filtri</button>
                        <a href="{{ url_for('visualizza_giacenze') }}" class="btn btn-sm btn-secondary">Reset</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Azioni principali -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Giacenze Magazzino</h4>
        <a href="{{ url_for('add_articolo') }}" class="btn btn-primary">Aggiungi Articolo</a>
    </div>

    <div class="mb-2">
        <button class="btn btn-sm btn-outline-primary" id="btn-buono">Crea Buono</button>
        <button class="btn btn-sm btn-outline-primary" id="btn-ddt">Crea DDT</button>
        <button class="btn btn-sm btn-outline-warning" id="btn-edit-multiple">Modifica Selez.</button>
        <button class="btn btn-sm btn-outline-info" id="btn-duplicate">Duplica Selez.</button>
        <button class="btn btn-sm btn-outline-secondary" id="btn-create-label">Crea Etichetta</button>
        <button class="btn btn-sm btn-outline-danger float-end" id="btn-delete-selected">Elimina Selez.</button>
    </div>

    <!-- Tabella con scroll -->
    <div class="card flex-grow-1">
        <div class="table-wrapper">
            <table class="table table-bordered table-hover table-giacenze">
                <thead>
                    <tr class="table-light">
                        <th><input type="checkbox" id="select-all"></th>
                        <th>Azioni</th>
                        <th>ID</th>
                        <th>Codice Articolo</th>
                        <th>Descrizione</th>
                        <th>Cliente</th>
                        <th>Fornitore</th>
                        <th>Data Ingresso</th>
                        <th>DDT Ingresso</th>
                        <th>DDT Uscita</th>
                        <th>Data Uscita</th>
                        <th>Buono N.</th>
                        <th>Larghezza</th>
                        <th>Lunghezza</th>
                        <th>Altezza</th>
                        <th>m²</th>
                        <th>m³</th>
                        <th>Commessa</th>
                        <th>Ordine</th>
                        <th>N. Colli</th>
                        <th>Peso</th>
                        <th>Posizione</th>
                        <th>Protocollo</th>
                        <th>Serial Number</th>
                        <th>N. Arrivo</th>
                        <th>Ns. Rif.</th>
                        <th>Mezzo in Uscita</th>
                    </tr>
                </thead>
                <tbody>
                    {% for articolo in articoli %}
                    <tr>
                        <td><input type="checkbox" class="articolo-checkbox" value="{{ articolo.id }}"></td>
                        <td><a href="{{ url_for('edit_articolo', id=articolo.id) }}" class="btn btn-sm btn-outline-primary py-0 px-1">Mod.</a></td>
                        <td>{{ articolo.id or '' }}</td>
                        <td>{{ articolo.codice_articolo or '' }}</td>
                        <td>{{ articolo.descrizione or '' }}</td>
                        <td>{{ articolo.cliente or '' }}</td>
                        <td>{{ articolo.fornitore or '' }}</td>
                        <td>{{ articolo.data_ingresso.strftime('%d/%m/%Y') if articolo.data_ingresso else '' }}</td>
                        <td>{{ articolo.n_ddt_ingresso or '' }}</td>
                        <td>{{ articolo.n_ddt_uscita or '' }}</td>
                        <td>{{ articolo.data_uscita.strftime('%d/%m/%Y') if articolo.data_uscita else '' }}</td>
                        <td>{{ articolo.buono_n or '' }}</td>
                        <td>{{ '%.2f'|format(articolo.larghezza|float) if articolo.larghezza else '' }}</td>
                        <td>{{ '%.2f'|format(articolo.lunghezza|float) if articolo.lunghezza else '' }}</td>
                        <td>{{ '%.2f'|format(articolo.altezza|float) if articolo.altezza else '' }}</td>
                        <td>{{ '%.3f'|format(articolo.m2|float) if articolo.m2 else '' }}</td>
                        <td>{{ '%.3f'|format(articolo.m3|float) if articolo.m3 else '' }}</td>
                        <td>{{ articolo.commessa or '' }}</td>
                        <td>{{ articolo.ordine or '' }}</td>
                        <td>{{ articolo.n_colli or '' }}</td>
                        <td>{{ articolo.peso or '' }}</td>
                        <td>{{ articolo.posizione or '' }}</td>
                        <td>{{ articolo.protocollo or '' }}</td>
                        <td>{{ articolo.serial_number or '' }}</td>
                        <td>{{ articolo.n_arrivo or '' }}</td>
                        <td>{{ articolo.ns_rif or '' }}</td>
                        <td>{{ articolo.mezzi_in_uscita or '' }}</td>
                    </tr>
                    {% else %}
                    <tr><td colspan="26" class="text-center">Nessun articolo trovato.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="card-footer text-end">
            <strong>Totali:</strong>
            Colli: {{ totali.colli }} |
            Peso: {{ '%.2f'|format(totali.peso) }} Kg |
            m²: {{ '%.3f'|format(totali.m2) }} |
            m³: {{ '%.3f'|format(totali.m3) }}
        </div>
    </div>
</div>

<form id="bulk-delete-form" method="POST" action="{{ url_for('bulk_delete') }}" style="display: none;">
    <input type="hidden" name="selected_ids" id="delete_ids_field">
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const selectAll = document.getElementById('select-all');
    selectAll.addEventListener('change', e => {
        document.querySelectorAll('.articolo-checkbox').forEach(cb => cb.checked = e.target.checked);
    });
});
</script>
{% endblock %}
