{% extends "layout.html" %}

{% block custom_css %}
<style>
  /* impedisce lo scroll dell'intera pagina */
  html, body { height: 100%; overflow: hidden; }

  /* layout a griglia: titolo, filtri, toolbar, tabella, footer */
  .page-grid {
    display: grid;
    grid-template-rows: auto auto auto 1fr auto; /* l'area tabella prende tutto (1fr) */
    gap: .75rem;
    height: calc(100vh - 56px); /* sottrae la topbar del layout; se diversa, adegua */
    padding: 1rem;
    box-sizing: border-box;
  }

  /* card filtri e barra comandi NON scrollano */
  .filters-card, .actions-bar, .totals-bar { min-height: 0; }

  /* wrapper con scroll */
  .table-wrapper {
    min-height: 0;                /* fondamentale in grid/flex */
    overflow: auto;               /* scroll solo qui */
    border: 1px solid #dee2e6;
    border-radius: .25rem;
    background: #fff;
  }

  /* tabella larga -> scrollbar X se necessario */
  table.table-giacenze{
    table-layout: fixed;
    min-width: 2400px;            /* adegua alla tua ampiezza colonnare */
    width: 100%;
    border-collapse: collapse;
    font-size: .875rem;
  }

  /* header sticky */
  .table-giacenze thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    text-align: center;
    padding: 6px;
  }

  .table-giacenze td, .table-giacenze th{
    white-space: normal; word-wrap: break-word;
    vertical-align: middle;
    padding: 4px 6px;
    border-bottom: 1px solid #dee2e6;
    border-left: 1px solid #dee2e6;
  }
  .table-giacenze th:first-child, .table-giacenze td:first-child { border-left: none; }
  .table-giacenze tbody tr:nth-child(even){ background:#f8f9fa; }

  /* footer totali fissato fuori tabella */
  .totals-bar {
    background:#f8f9fa; border-top:1px solid #dee2e6;
    padding: 8px 12px; font-size: .9rem; text-align: end;
  }

  /* larghezze indicative */
  .col-check{width:40px}.col-azioni{width:72px;text-align:center}.col-id{width:70px}
  .col-codice{width:240px}.col-desc{width:320px}
  .col-cliente,.col-fornitore{width:150px}.col-data{width:110px}.col-stato{width:100px}
  .col-ddt{width:120px}.col-misure{width:90px;text-align:right}
  .col-buono,.col-commessa,.col-ordine,.col-protocollo,.col-nsrif,.col-narrivo{width:150px}
  .col-serial,.col-posizione,.col-mezzo{width:180px}
</style>
{% endblock %}

{% block content %}
<div class="page-grid">

  <div class="d-flex justify-content-between align-items-center">
    <h3 class="mb-0">Giacenze Magazzino</h3>
    <a href="{{ url_for('add_articolo') }}" class="btn btn-primary">
      <i class="bi bi-plus-circle-fill me-2"></i>Aggiungi Articolo
    </a>
  </div>

  <div class="accordion filters-card" id="filtriAccordion">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingOne">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseFiltri" aria-expanded="false" aria-controls="collapseFiltri">
          Filtri di Ricerca (Clicca per Aprire)
        </button>
      </h2>
      <div id="collapseFiltri" class="accordion-collapse collapse" data-bs-parent="#filtriAccordion">
        <div class="accordion-body">
          <form method="get" action="{{ url_for('visualizza_giacenze') }}">
            <div class="row g-3">
              <!-- i tuoi campi filtro invariati -->
              <div class="col-md-2"><label class="form-label">ID</label>
                <input type="text" name="id" class="form-control form-control-sm" value="{{ filters.get('id','') }}">
              </div>
              <!-- ... (tutti gli altri input come li avevi) ... -->
            </div>
            <hr>
            <div class="d-flex justify-content-end">
              <a href="{{ url_for('visualizza_giacenze') }}" class="btn btn-sm btn-outline-secondary me-2">Reset Filtri</a>
              <button type="submit" class="btn btn-sm btn-primary">Applica Filtri</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="actions-bar">
    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-buono">Crea Buono</button>
    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-ddt">Crea DDT</button>
    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-create-label">Stampa Etichetta</button>
    <button type="button" class="btn btn-sm btn-info text-white" id="btn-edit-multiple">Modifica Selez.</button>
    <button type="button" class="btn btn-sm btn-warning" id="btn-duplicate">Duplica Selez.</button>
    <button type="button" class="btn btn-sm btn-danger" id="btn-delete-selected">Elimina Selez.</button>
    <button type="button" class="btn btn-sm btn-success" id="btn-send-email">Invia E-mail</button>
  </div>

  <div class="table-wrapper">
    <table class="table table-bordered table-hover table-sm table-giacenze">
      <thead>
      <tr class="table-light">
        <th class="col-check no-print"><input type="checkbox" id="select-all" class="form-check-input"></th>
        <th class="col-azioni no-print">Azioni</th>
        <th class="col-id">ID</th>
        <th class="col-codice">Codice Articolo</th>
        <th class="col-desc">Descrizione</th>
        <th class="col-cliente">Cliente</th>
        <th class="col-fornitore">Fornitore</th>
        <th class="col-data">Data Ingresso</th>
        <th class="col-stato">Stato</th>
        <th class="col-ddt">DDT Ingresso</th>
        <th class="col-ddt">DDT Uscita</th>
        <th class="col-data">Data Uscita</th>
        <th class="col-buono">Buono N.</th>
        <th class="col-misure">Larghezza</th>
        <th class="col-misure">Lunghezza</th>
        <th class="col-misure">Altezza</th>
        <th class="col-misure">m²</th>
        <th class="col-misure">m³</th>
        <th class="col-commessa">Commessa</th>
        <th class="col-ordine">Ordine</th>
        <th class="col-misure">N. Colli</th>
        <th class="col-misure">Peso</th>
        <th class="col-posizione">Posizione</th>
        <th class="col-protocollo">Protocollo</th>
        <th class="col-serial">Serial Number</th>
        <th class="col-narrivo">N. Arrivo</th>
        <th class="col-nsrif">Ns. Rif.</th>
        <th class="col-mezzo">Mezzo in Uscita</th>
      </tr>
      </thead>
      <tbody>
      {% for articolo in articoli %}
        <tr class="{% if articolo.data_uscita %}text-muted{% endif %}">
          <td class="no-print"><input type="checkbox" class="articolo-checkbox form-check-input" value="{{ articolo.id }}"></td>
          <td class="no-print"><a href="{{ url_for('edit_articolo', id=articolo.id) }}" class="btn btn-sm btn-primary py-0 px-1">Mod.</a></td>
          <td>{{ articolo.id or '' }}</td>
          <td>{{ articolo.codice_articolo or '' }}</td>
          <td>{{ articolo.descrizione or '' }}</td>
          <td>{{ articolo.cliente or '' }}</td>
          <td>{{ articolo.fornitore or '' }}</td>
          <td>{{ articolo.data_ingresso.strftime('%d/%m/%Y') if articolo.data_ingresso else '' }}</td>
          <td>{{ articolo.stato or ''}}</td>
          <td>{{ articolo.n_ddt_ingresso or '' }}</td>
          <td>{{ articolo.n_ddt_uscita or '' }}</td>
          <td>{{ articolo.data_uscita.strftime('%d/%m/%Y') if articolo.data_uscita else '' }}</td>
          <td>{{ articolo.buono_n or '' }}</td>
          <td class="text-end">{{ '%.2f'|format(articolo.larghezza|float) if articolo.larghezza else '' }}</td>
          <td class="text-end">{{ '%.2f'|format(articolo.lunghezza|float) if articolo.lunghezza else '' }}</td>
          <td class="text-end">{{ '%.2f'|format(articolo.altezza|float) if articolo.altezza else '' }}</td>
          <td class="text-end">{{ '%.3f'|format(articolo.m2|float) if articolo.m2 else '' }}</td>
          <td class="text-end">{{ '%.3f'|format(articolo.m3|float) if articolo.m3 else '' }}</td>
          <td>{{ articolo.commessa or '' }}</td>
          <td>{{ articolo.ordine or '' }}</td>
          <td class="text-end">{{ articolo.n_colli or '' }}</td>
          <td class="text-end">{{ articolo.peso or '' }}</td>
          <td>{{ articolo.posizione or '' }}</td>
          <td>{{ articolo.protocollo or '' }}</td>
          <td>{{ articolo.serial_number or '' }}</td>
          <td>{{ articolo.n_arrivo or '' }}</td>
          <td>{{ articolo.ns_rif or '' }}</td>
          <td>{{ articolo.mezzi_in_uscita or '' }}</td>
        </tr>
      {% else %}
        <tr><td colspan="28" class="text-center">Nessun articolo trovato.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="totals-bar">
    <strong>Totali merce in giacenza:</strong>
    Colli: {{ totali.colli }} |
    Peso: {{ '%.2f'|format(totali.peso) }} Kg |
    m²: {{ '%.3f'|format(totali.m2) }} |
    m³: {{ '%.3f'|format(totali.m3) }}
  </div>

</div>

<form id="bulk-delete-form" method="POST" action="{{ url_for('bulk_delete') }}" style="display:none">
  <input type="hidden" name="selected_ids" id="delete_ids_field">
</form>
<form id="bulk-duplicate-form" method="POST" action="{{ url_for('bulk_duplicate') }}" style="display:none">
  <input type="hidden" name="selected_ids" id="duplicate_ids_field">
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const selectAll = document.getElementById('select-all');
  if (selectAll){
    selectAll.addEventListener('change', e=>{
      document.querySelectorAll('.articolo-checkbox').forEach(cb => cb.checked = e.target.checked);
    });
  }
  const getSelectedIds = () => Array.from(document.querySelectorAll('.articolo-checkbox:checked')).map(cb => cb.value);

  function handleBulkActionGet(baseUrl){
    const ids = getSelectedIds();
    if (!ids.length) return alert("Seleziona almeno un articolo.");
    const url = new URL(baseUrl, window.location.origin);
    url.searchParams.set('ids', ids.join(','));
    window.location.href = url.href;
  }

  function handleBulkActionPost(formId, idsFieldId, message, single=false){
    const ids = getSelectedIds();
    if (!ids.length) return alert("Seleziona almeno un articolo.");
    if (single && ids.length>1) return alert("Questa azione richiede un solo articolo.");
    if (confirm(message)){
      const form = document.getElementById(formId);
      const field = document.getElementById(idsFieldId);
      field.value = ids.join(',');
      form.submit();
    }
  }

  document.getElementById('btn-buono')?.addEventListener('click', ()=> handleBulkActionGet('{{ url_for('buono_setup') }}'));
  document.getElementById('btn-ddt')?.addEventListener('click',   ()=> handleBulkActionGet('{{ url_for('ddt_setup') }}'));
  document.getElementById('btn-edit-multiple')?.addEventListener('click', ()=> handleBulkActionGet('{{ url_for('edit_multiple') }}'));
  document.getElementById('btn-create-label')?.addEventListener('click',  ()=> handleBulkActionGet('{{ url_for('etichetta_manuale') }}'));

  document.getElementById('btn-duplicate')?.addEventListener('click', ()=> handleBulkActionPost(
    'bulk-duplicate-form','duplicate_ids_field', `Duplicare ${getSelectedIds().length} articoli?`, true));
  document.getElementById('btn-delete-selected')?.addEventListener('click', ()=> handleBulkActionPost(
    'bulk-delete-form','delete_ids_field', `Eliminare ${getSelectedIds().length} articoli? Azione irreversibile.`, false));

  // invio email (apre pagina dedicata con gli ID)
  document.getElementById('btn-send-email')?.addEventListener('click', ()=> handleBulkActionGet('{{ url_for('email_setup') }}'));
});
</script>
{% endblock %}
