{% extends "layout.html" %}

{% block custom_css %}
<style>
    /* Contenitore per permettere lo scorrimento orizzontale */
    .table-container {
        overflow-x: auto;
    }

    /* Stile generale della tabella */
    .table-giacenze {
        table-layout: fixed; /* Fondamentale per rispettare le larghezze delle colonne */
        width: 100%;         /* La tabella occupa tutta la larghezza del contenitore */
    }

    /* Stile per tutte le celle, header (th) e dati (td) */
    .table-giacenze th,
    .table-giacenze td {
        vertical-align: middle;  /* Allinea il testo verticalmente al centro */
        white-space: normal;     /* Permette al testo di andare a capo */
        word-wrap: break-word;   /* Forza il testo ad andare a capo se una parola è troppo lunga */
    }

    /* Larghezze specifiche per ogni colonna per un layout ordinato */
    .col-check { width: 40px; }
    .col-azioni { width: 70px; }
    .col-id { width: 70px; }
    .col-codice { width: 250px; } /* Colonna Codice Art. più larga */
    .col-desc { width: 350px; }   /* Colonna Descrizione ancora più larga */
    .col-cliente { width: 150px; }
    .col-fornitore { width: 150px; }
    .col-data { width: 110px; }
    .col-stato { width: 100px; }
    .col-ddt { width: 120px; }
    .col-misure { width: 90px; } /* Colonne per le misure */
</style>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Giacenze Magazzino</h3>
    <a href="{{ url_for('add_articolo') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle-fill me-2"></i>Aggiungi Articolo
    </a>
</div>

<div class="card mb-3">
    <div class="card-body">
        <form method="get" action="{{ url_for('visualizza_giacenze') }}">
             <div class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small">ID</label>
                    <input type="text" name="id" class="form-control form-control-sm" value="{{ filters.get('id', '') }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Codice Articolo</label>
                    <input type="text" name="codice_articolo" class="form-control form-control-sm" value="{{ filters.get('codice_articolo', '') }}">
                </div>
                 <div class="col-md-3">
                    <label class="form-label small">Descrizione</label>
                    <input type="text" name="descrizione" class="form-control form-control-sm" value="{{ filters.get('descrizione', '') }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Cliente</label>
                    <input type="text" name="cliente" class="form-control form-control-sm" value="{{ filters.get('cliente', '') }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-sm btn-secondary w-100">Filtra</button>
                    <a href="{{ url_for('visualizza_giacenze') }}" class="btn btn-sm btn-outline-secondary w-100 ms-2">Reset</a>
                </div>
            </div>
        </form>
    </div>
</div>


<div class="card">
    <div class="card-body">
        <div class="mb-3">
            <button class="btn btn-sm btn-outline-secondary" onclick="handleBulkAction('{{ url_for('buono_setup') }}')">Crea Buono</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="handleBulkAction('{{ url_for('ddt_setup') }}')">Crea DDT</button>
            <button class="btn btn-sm btn-outline-secondary" onclick="handleBulkAction('{{ url_for('etichetta_manuale') }}')">Stampa Etichetta</button>
            <button class="btn btn-sm btn-info text-white" onclick="handleBulkAction('{{ url_for('edit_multiple') }}')">Modifica Selez.</button>
            <button class="btn btn-sm btn-warning" onclick="handleBulkAction('{{ url_for('duplica_articolo') }}')">Duplica Selez.</button>
            <button class="btn btn-sm btn-danger" onclick="deleteSelected()">Elimina Selez.</button>
        </div>

        <form id="bulk-form" method="get">
            <div class="table-container">
                <table class="table table-bordered table-hover table-sm table-giacenze">
                    <thead>
                        <tr class="table-light">
                            <th class="col-check"><input type="checkbox" id="select-all"></th>
                            <th class="col-azioni">Azioni</th>
                            <th class="col-id">ID</th>
                            <th class="col-codice">Codice Art.</th>
                            <th class="col-desc">Descrizione</th>
                            <th class="col-cliente">Cliente</th>
                            <th class="col-fornitore">Fornitore</th>
                            <th class="col-data">Data Ingresso</th>
                            <th class="col-stato">Stato</th>
                            <th class="col-ddt">DDT Ingresso</th>
                            <th class="col-ddt">DDT Uscita</th>
                            <th class="col-data">Data Uscita</th>
                            <th class="col-misure">Larghezza</th>
                            <th class="col-misure">Lunghezza</th>
                            <th class="col-misure">Altezza</th>
                            <th class="col-misure">m²</th>
                            <th class="col-misure">m³</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for articolo in articoli %}
                        <tr class="{{ 'table-secondary text-muted' if articolo.stato == 'Uscito' else '' }}">
                            <td><input type="checkbox" name="ids" value="{{ articolo.id }}" class="form-check-input"></td>
                            <td>
                                <a href="{{ url_for('edit_articolo', id=articolo.id) }}" class="btn btn-sm btn-primary">Mod.</a>
                            </td>
                            <td>{{ articolo.id }}</td>
                            <td>{{ articolo.codice_articolo }}</td>
                            <td>{{ articolo.descrizione }}</td>
                            <td>{{ articolo.cliente }}</td>
                            <td>{{ articolo.fornitore }}</td>
                            <td>{{ articolo.data_ingresso.strftime('%d/%m/%Y') if articolo.data_ingresso }}</td>
                            <td>{{ articolo.stato }}</td>
                            <td>{{ articolo.n_ddt_ingresso }}</td>
                            <td>{{ articolo.n_ddt_uscita }}</td>
                            <td>{{ articolo.data_uscita.strftime('%d/%m/%Y') if articolo.data_uscita }}</td>
                            <td>{{ '%.2f'|format(articolo.larghezza|float) if articolo.larghezza is not none }}</td>
                            <td>{{ '%.2f'|format(articolo.lunghezza|float) if articolo.lunghezza is not none }}</td>
                            <td>{{ '%.2f'|format(articolo.altezza|float) if articolo.altezza is not none }}</td>
                            <td>{{ '%.3f'|format(articolo.m2|float) if articolo.m2 is not none }}</td>
                            <td>{{ '%.3f'|format(articolo.m3|float) if articolo.m3 is not none }}</td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="17" class="text-center">Nessun articolo trovato.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
    <div class="card-footer">
        <strong>Totali merce in giacenza:</strong>
        Colli: {{ totali.colli }} |
        Peso: {{ '%.2f'|format(totali.peso) }} Kg |
        m²: {{ '%.3f'|format(totali.m2) }} |
        m³: {{ '%.3f'|format(totali.m3) }}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('select-all').addEventListener('change', function(e) {
    document.querySelectorAll('input[name="ids"]').forEach(checkbox => {
        checkbox.checked = e.target.checked;
    });
});

function getSelectedIds() {
    return Array.from(document.querySelectorAll('input[name="ids"]:checked')).map(cb => cb.value);
}

function handleBulkAction(url) {
    const ids = getSelectedIds();
    if (ids.length === 0) {
        alert("Seleziona almeno un articolo.");
        return;
    }
     // Per la duplicazione, prendi solo il primo ID
    if (url.includes('duplica')) {
        window.location.href = url + '?ids=' + ids[0];
        return;
    }
    window.location.href = url + '?ids=' + ids.join(',');
}

function deleteSelected() {
    const ids = getSelectedIds();
    if (ids.length === 0) {
        alert("Seleziona almeno un articolo per l'eliminazione.");
        return;
    }
    if (confirm(`Sei sicuro di voler eliminare ${ids.length} articoli? L'azione è irreversibile.`)) {
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '{{ url_for("bulk_delete") }}';

        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'selected_ids';
        hiddenInput.value = ids.join(',');
        form.appendChild(hiddenInput);

        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
