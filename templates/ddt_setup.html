{% extends "layout.html" %}

{% block custom_css %}
<style>
    .ddt-card {
        border: 1px solid #ddd;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        padding: 20px;
        background-color: #fff;
    }

    .ddt-header {
        background-color: #0d6efd;
        color: white;
        padding: 12px 20px;
        border-radius: 8px 8px 0 0;
        margin: -20px -20px 20px -20px;
    }

    .ddt-header h4 {
        margin: 0;
        font-size: 1.2rem;
    }

    .table-ddt {
        font-size: 0.9rem;
    }

    .table-ddt th {
        background-color: #f0f2f5;
        text-align: center;
    }

    .table-ddt td {
        vertical-align: middle;
    }

    .totali-box {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 10px 15px;
        font-weight: 600;
    }

    .form-section {
        background-color: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .form-section h6 {
        font-weight: 600;
        color: #0d6efd;
        border-bottom: 1px solid #ddd;
        padding-bottom: 6px;
        margin-bottom: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4 mb-5">
    <div class="ddt-card">
        <div class="ddt-header">
            <h4><i class="bi bi-truck"></i> Creazione DDT</h4>
        </div>

        <form method="post" action="{{ url_for('ddt_finalize') }}">
            <input type="hidden" name="ids" value="{{ ids }}">

            <!-- DATI PRINCIPALI -->
            <div class="form-section">
                <h6>Dati Principali</h6>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Numero DDT</label>
                        <input type="text" name="n_ddt" class="form-control" id="n_ddt" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Uscita</label>
                        <input type="date" name="data_uscita" class="form-control" value="{{ today }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Targa Mezzo</label>
                        <input type="text" name="targa" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Causale Trasporto</label>
                        <input type="text" name="causale_trasporto" class="form-control" value="C/Lavorazione">
                    </div>
                </div>
            </div>

            <!-- DESTINATARIO -->
            <div class="form-section">
                <h6>Destinatario</h6>
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label class="form-label">Seleziona Destinatario Salvato</label>
                        <select name="destinatario_key" class="form-select">
                            <option value="">-- Seleziona --</option>
                            {% for key, dest in destinatari.items() %}
                                <option value="{{ key }}">{{ key }} - {{ dest.ragione_sociale }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Destinatario (manuale)</label>
                        <input type="text" name="destinatario" class="form-control" placeholder="Inserisci nome completo...">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Aspetto Beni</label>
                        <input type="text" name="aspetto_beni" class="form-control" value="Scatole/Pallet">
                    </div>
                </div>
            </div>

            <!-- ARTICOLI -->
            <div class="form-section">
                <h6>Articoli Selezionati</h6>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm table-ddt align-middle">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Codice</th>
                                <th>Descrizione</th>
                                <th>Colli</th>
                                <th>Peso (Kg)</th>
                                <th>Commessa</th>
                                <th>Cliente</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for art in articoli %}
                            <tr>
                                <td>{{ art.id }}</td>
                                <td>{{ art.codice_articolo }}</td>
                                <td>{{ art.descrizione }}</td>
                                <td><input type="number" class="form-control form-control-sm" name="colli_{{ art.id }}" value="{{ art.n_colli or 0 }}" min="0"></td>
                                <td><input type="number" class="form-control form-control-sm" name="peso_{{ art.id }}" value="{{ art.peso or 0 }}" step="0.01" min="0"></td>
                                <td>{{ art.commessa }}</td>
                                <td>{{ art.cliente }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="totali-box mt-2">
                    Totale Colli: {{ tot_colli }} | Peso Totale: {{ '%.2f'|format(tot_peso) }} Kg
                </div>
            </div>

            <!-- ALTRE INFO -->
            <div class="form-section">
                <h6>Altri Dati</h6>
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Buono N.</label>
                        <input type="text" name="buono_n" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Commessa</label>
                        <input type="text" name="commessa" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Ordine</label>
                        <input type="text" name="ordine" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Protocollo</label>
                        <input type="text" name="protocollo" class="form-control">
                    </div>
                </div>
            </div>

            <!-- BOTTONI -->
            <div class="d-flex justify-content-between mt-4">
                <a href="{{ url_for('visualizza_giacenze') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Annulla
                </a>
                <div class="d-flex gap-2">
                    <button type="submit" formaction="{{ url_for('ddt_preview') }}" formtarget="_blank" class="btn btn-info text-white">
                        <i class="bi bi-eye-fill"></i> Anteprima PDF
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check2-circle"></i> Genera DDT
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Ottiene automaticamente il prossimo numero DDT
    document.addEventListener("DOMContentLoaded", () => {
        fetch("{{ url_for('get_next_ddt_number') }}")
            .then(response => response.json())
            .then(data => {
                document.getElementById('n_ddt').value = data.next_ddt;
            })
            .catch(err => console.error("Errore caricamento progressivo DDT:", err));
    });
</script>
{% endblock %}

